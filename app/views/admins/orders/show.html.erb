<div class=" orders show container">
  <div class="row">
<h1>注文詳細画面</h1>
<%= render partial: 'layouts/flash', flash: flash %>
<div class="row">
<div class="col col-xs-8">
<h2>注文情報</h2>
<table>
	<tbody>
		<tr>
			<td>購入者</td>
			<td>
				<%= link_to admins_customer_path(@order.customer_id) do %>
				<%= @order.customer.family_name %>
				<%= @order.customer.first_name %>
				<% end %>
			</td>
		</tr>
		<tr>
			<td>配送先</td>
			<td><%= @order.send_to_address %></td>
		</tr>
		<tr>
			<td>支払方法</td>
			<td><%= render 'orders/how_to_pay', order: @order %></td>
		</tr>
		<tr>
			<td>注文ステータス</td>
			<td><%= form_with model: @order,url: admins_order_path(@order), local: true do |f| %>
				<%= f.select :order_status, [["入金待ち", 0],["入金確認", 1],["製作中", 2],["発送準備中", 3],["発送済み", 4],], value: @order.order_status %>
				<%= f.submit "更新", class: "btn btn-primary" %>
				<% end %>
			</td>
		</tr>
	</tbody>
</table>
</div>
</div>
<div class="row">
<div class="col col-xs-8">
<table>
	<thead>
		<tr>
			<th>商品</th>
			<th>単価（税込）</th>
			<th>個数</th>
			<th>小計</th>
			<th></th>
			<th>製作ステータス</th>
		</tr>
	</thead>
	<tbody>
		<% sum = 0 %>
		<% @order.order_items.each do |order_item| %>
		<tr>
			<td><%= order_item.product.name %></td>
			<td>
				<% price_plus_tax = order_item.order_price.to_i * 1.08 %>
				<%= price_plus_tax.to_i %>円
			</td>
			<td><%= order_item.quantity %>個</td>
			<td><%= sub_total = price_plus_tax.to_i * order_item.quantity %>円</td>
			<% sum += sub_total %>
			<td>
				<th>
					<%= order_item.make_status %>
					<%#= form_with model: @order_item, local: true do |f| %>
					<%= form_with(url: admins_order_item_path, method: :patch, local:true)  do |f| %>
					<%= f.select :make_status, [["着手不可", 0],["制作待ち", 1],["製作中", 2],["制作完了", 3],] ,selected: order_item.make_status %>
					<!-- value: @order.order_item_make_status を入れる-->
					<%= f.hidden_field :order_item_id, :value => order_item.id %>
					<%= f.submit "更新", class: "btn btn-primary" %>
					<% end %>
				</th>
			</td>
		</tr>
		<% end %>

	</tbody>
</table>
</div>

<div class="col col-xs-4">
 <table>
	<tbody>
		<tr>
			<td>商品合計</td>
			<td>
				<%= total_price = sum %>円
			</td>
		</tr>
		<tr>
			<td>送料</td>
			<td><%= @order.deliver_fee %>円</td>
		</tr>
		<tr>
			<td>請求金額合計</td>
			<td>
				<% billing_amount = total_price.to_i + @order.deliver_fee.to_i %>
				<%= billing_amount %>円
			</td>
		</tr>
	</tbody>
</table>
</div>
</div>
</div>
</div>